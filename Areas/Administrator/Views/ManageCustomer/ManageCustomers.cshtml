@model FridgeManagementSystem.Models.ManageCustomersViewModel

@{
    ViewData["Title"] = "Manage Customers";
}

<div class="row">

    <!-- Left Panel: Customer List -->
    <div class="col-md-3 border-end">
        <h5 class="mt-3">Customers</h5>

        <!-- Search Box -->
        <input type="text" class="form-control mb-2" id="customerSearch" placeholder="Search by name/shop type..." onkeyup="filterCustomers()" />

        <!-- Filter by Shop Type -->
        <select class="form-select mb-2" id="shopTypeFilter" onchange="filterCustomers()">
            <option value="">All Shop Types</option>
            <option value="Spaza">Spaza</option>
            <option value="Shebeen">Shebeen</option>
            <option value="Restaurant">Restaurant</option>
        </select>

        <!-- Customer List -->
        <ul class="list-group" id="customerList">
            @foreach (var c in Model.AllCustomers)
            {
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <a asp-action="Index" asp-route-selectedCustomerId="@c.CustomerID">
                        @c.FullName (@c.ShopType)
                    </a>
                    <span class="badge @(c.IsActive ? "bg-success" : "bg-secondary")">
                        @(c.IsActive ? "Active" : "Inactive")
                    </span>
                </li>
            }
        </ul>

        <button class="btn btn-primary btn-sm mt-3" asp-action="Create">Add New Customer</button>
    </div>

    <!-- Right Panel: Selected Customer Dashboard -->
    <div class="col-md-9">
        @if (Model.SelectedCustomer != null)
        {
            var customer = Model.SelectedCustomer;
            <h3 class="mt-3">@customer.FullName - Dashboard</h3>

            <div class="row">

                <!-- Profile -->
                <div class="col-md-6 mb-3">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">
                                Profile
                                <a asp-controller="CustomerLiaison" asp-action="Details" asp-route-id="@customer.CustomerID" class="btn btn-link btn-sm">Go to Customer Manager</a>
                                <a asp-controller="CustomerLiaison" asp-action="Edit" asp-route-id="@customer.CustomerID" class="btn btn-link btn-sm">Edit Profile</a>
                            </h5>
                            <p><strong>Name:</strong> @customer.FullName</p>
                            <p><strong>Shop Type:</strong> @customer.ShopType</p>
                            <p><strong>Phone:</strong> @customer.PhoneNumber</p>
                            <p><strong>Email:</strong> @customer.Email</p>
                            <p><strong>Address:</strong> @customer.LocationId</p>
                            <p><strong>Status:</strong> @(customer.IsActive ? "Active" : "Inactive")</p>
                        </div>
                    </div>
                </div>

                <!-- Fridge Allocations -->
                <div class="col-md-6 mb-3">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">
                                Fridge Allocations
                                <a asp-controller="CustomerLiaison" asp-action="Allocate" asp-route-customerId="@customer.CustomerID" class="btn btn-link btn-sm">Go to Fridge Manager</a>
                            </h5>
                            @if (customer.FridgeAllocation.Any())
                            {
                                <ul>
                                    @foreach (var allocation in customer.FridgeAllocation)
                                    {
                                        <li>@allocation.Fridge.Model (@allocation.Fridge.SerialNumber) - @allocation.Fridge.Status</li>
                                    }
                                </ul>
                            }
                            else
                            {
                                <p>No fridges allocated.</p>
                            }
                        </div>
                    </div>
                </div>

                <!-- Fault Reports -->
                <div class="col-md-6 mb-3">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">
                                Fault Reports
                                <a asp-controller="Fault" asp-action="Index" asp-route-customerId="@customer.CustomerID" class="btn btn-link btn-sm">Go to Fault Manager</a>
                            </h5>
                            @if (customer.FaultReports.Any())
                            {
                                <ul>
                                    @foreach (var fault in customer.FaultReports)
                                    {
                                        <li>@fault.ReportDate.ToShortDateString() - @fault.FaultDescription (@fault.StatusFilter)</li>
                                    }
                                </ul>
                            }
                            else
                            {
                                <p>No faults reported.</p>
                            }
                        </div>
                    </div>
                </div>

                <!-- Service History -->
                <div class="col-md-6 mb-3">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">
                                Service History
                                <a asp-controller="Maintenance" asp-action="ServiceHistory" asp-route-customerId="@customer.CustomerID" class="btn btn-link btn-sm">Go to Maintenance Manager</a>
                            </h5>
                            @if (customer.ServiceHistories.Any())
                            {
                                <ul>
                                    @foreach (var service in customer.ServiceHistories.OrderByDescending(s => s.LastServiced))
                                    {
                                        <li>@service.LastServiced.ToShortDateString() - @service.ServiceDetails by @service.TechnicianID</li>
                                    }
                                </ul>
                            }
                            else
                            {
                                <p>No service history available.</p>
                            }
                        </div>
                    </div>
                </div>

                <!-- Notes / Customer Communication -->
                <div class="col-md-12 mb-3">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">Notes / Customer Communication</h5>
                            @if (customer.CustomerNote.Any())
                            {
                                <ul>
                                    @foreach (var note in customer.CustomerNote)
                                    {
                                        <li>@note.CreatedAt.ToShortDateString(): @note.Note</li>
                                    }
                                </ul>
                            }
                            else
                            {
                                <p>No notes recorded.</p>
                            }

                            <form asp-controller="CustomerManagement" asp-action="AddNote" method="post">
                                <input type="hidden" name="CustomerId" value="@customer.CustomerID" />
                                <div class="mb-2">
                                    <textarea name="Note" class="form-control" placeholder="Write a note or message"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary btn-sm">Send / Save</button>
                            </form>
                        </div>
                    </div>
                </div>

            </div>
        }
        else
        {
            <p class="mt-3">Select a customer from the list to view details.</p>
        }
    </div>
</div>

<script>
    function filterCustomers() {
        var input = document.getElementById("customerSearch").value.toLowerCase();
        var typeFilter = document.getElementById("shopTypeFilter").value;
        var ul = document.getElementById("customerList");
        var li = ul.getElementsByTagName("li");

        for (var i = 0; i < li.length; i++) {
            var text = li[i].innerText.toLowerCase();
            var type = li[i].innerText.match(/\(([^)]+)\)/)?.[1] || "";
            if (text.includes(input) && (typeFilter === "" || type === typeFilter)) {
                li[i].style.display = "";
            } else {
                li[i].style.display = "none";
            }
        }
    }
</script>

