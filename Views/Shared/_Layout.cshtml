@inject FridgeManagementSystem.Services.INotificationService NotificationService
@using System.Security.Claims

@{
    var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier);
    int currentUserId = 0;
    if (userIdClaim != null) int.TryParse(userIdClaim.Value, out currentUserId);
    var unread = currentUserId == 0 ? new List<FridgeManagementSystem.Models.Notification>()
                : NotificationService.GetUnreadAsync(currentUserId, 5).GetAwaiter().GetResult();
    int unreadCount = unread.Count();

    var currentController = ViewContext.RouteData.Values["controller"]?.ToString();
    bool isHomePage = currentController == "Home";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - FridgeManagementSystem</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/FridgeManagementSystem.styles.css" asp-append-version="true" />
    <!-- Add this to your _Layout.cshtml in the head section -->
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    @RenderSection("Styles", required: false)

    <style>
        html {
            scroll-behavior: smooth;
        }

        .global-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('@Url.Content("~/images/backgroundPicture.jpg")');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: -1;
        }

        /* Navbar for Home Page */
        .top-navbar {
            background-color: rgba(12, 75, 51, 0.9);
            backdrop-filter: blur(5px);
        }

            .top-navbar .nav-link {
                color: white !important;
                font-weight: 500;
                margin-right: 15px;
                transition: color 0.3s;
            }

                .top-navbar .nav-link:hover {
                    color: #a5d6a7 !important;
                }

        section {
            padding: 80px 0;
        }

        #home {
            height: 100vh;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
        }

        .sidebar {
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .sidebar-welcome {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: black;
        }

            .sidebar-welcome h4 {
                font-size: 1rem;
                margin: 0;
                font-weight: 500;
            }

            .sidebar-welcome h1 {
                font-size: 2rem;
                margin: 0;
                font-weight: 800;
                line-height: 1.2;
            }
    </style>
</head>

<body>
    <div class="global-background"></div>

    @if (isHomePage)
    {
        <!-- 🌐 Home Page Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark top-navbar fixed-top">
            <div class="container">
                <a class="navbar-brand fw-bold" asp-controller="Home" asp-action="Index">Fridge Management System</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item"><a class="nav-link" href="#home">Home</a></li>
                        <li class="nav-item"><a class="nav-link" href="#about">About</a></li>
                        <li class="nav-item"><a class="nav-link" href="#services">Services</a></li>
                        <li class="nav-item"><a class="nav-link" href="#team">Team</a></li>
                        <li class="nav-item"><a class="nav-link" href="#contact">Contact</a></li>
                        <li class="nav-item"><a class="nav-link" asp-controller="Home" asp-action="FAQ">FAQ</a></li>
                        <li class="nav-item"><a class="nav-link" asp-controller="Account" asp-action="Login">Sign In</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <main role="main" class="mt-5 pt-5">
            @RenderBody()
        </main>
    }
    else
    {
        <!-- 🌍 Dashboard & Subsystems Layout -->
        <div class="container-fluid">
            <div class="row">
                @if (ViewData["Sidebar"]?.ToString() == "CustomerManagementSubSystem" ||
               ViewData["Sidebar"]?.ToString() == "PurchasingSubSystem" ||
               ViewData["Sidebar"]?.ToString() == "FaultTechSubsystem" ||
               ViewData["Sidebar"]?.ToString() == "MaintenanceSubSystem")
                {
                    <div class="col-3">
                        <div class="sidebar bg-light p-3 border rounded">
                            @if (ViewData["Sidebar"]?.ToString() == "CustomerManagementSubSystem")
                            {
                                <partial name="_CustomerSidebar" />
                            }
                            else if (ViewData["Sidebar"]?.ToString() == "PurchasingSubSystem")
                            {
                                <partial name="_PurchasingSidebar" />
                            }
                            else if (ViewData["Sidebar"]?.ToString() == "FaultTechSubsystem")
                            {
                                <partial name="_FaultTechSidebar" />
                            }
                            else if (ViewData["Sidebar"]?.ToString() == "MaintenanceSubSystem")
                            {
                                <partial name="_MaintenanceSidebar" />
                            }
                        </div>
                    </div>
                }

                <div class="col">
                    <main role="main" class="pb-3">
                        @RenderBody()
                    </main>
                </div>
            </div>
        </div>

        <footer class="border-top footer text-muted mt-3">
            <div class="container">
                &copy; 2025 - Dynamic Ice Inc -
                <a asp-area="" asp-controller="Home" asp-action="Privacy">Privacy</a>
            </div>
        </footer>
    }

    <!-- 🔔 Notification dropdown -->
    <li class="nav-item dropdown">
        <a class="nav-link position-relative" href="#" id="notifDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-bell"></i>
            @if (unreadCount > 0)
            {
                <span class="badge bg-danger position-absolute top-0 start-100 translate-middle">@unreadCount</span>
            }
        </a>
        <ul class="dropdown-menu dropdown-menu-end p-2" aria-labelledby="notifDropdown" style="min-width:300px;">
            @if (unread.Any())
            {
                foreach (var n in unread)
                {
                    <li>
                        <a class="dropdown-item" href="@n.Url ?? " #"" onclick="markAsRead(@n.NotificationId)">
                            <div class="small text-muted">@n.CreatedAt.ToLocalTime().ToString("g")</div>
                            <div>@n.Message</div>
                        </a>
                    </li>
                    <li><hr class="dropdown-divider" /></li>
                }
                <li>
                    <a class="dropdown-item text-center" href="@Url.Action("All", "Notifications")">View all notifications</a>
                </li>
            }
            else
            {
                <li><span class="dropdown-item text-muted">No new notifications</span></li>
            }
        </ul>
    </li>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>


    @await RenderSectionAsync("Scripts", required: false)

    <script>
        async function markAsRead(id) {
            try {
                await fetch('/Notifications/MarkAsRead?id=' + id, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });
                location.href = document.querySelector('[data-notif-id="' + id + '"]')?.getAttribute('data-url') || '/';
            } catch (e) {
                console.error(e);
            }
        }
    </script>
</body>
</html>

